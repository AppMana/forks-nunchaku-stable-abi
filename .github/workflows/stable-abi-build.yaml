name: Stable ABI Build
on:
  workflow_dispatch:
permissions:
  contents: write
jobs:
  release:
    name: Tag Main Branch and Create Release
    runs-on: ubuntu-latest
    if: github.repository == 'nunchaku-ai/nunchaku'
    outputs:
      tag_name: ${{ steps.set-tag.outputs.tag_name }}
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main
      - name: Extract version from __version__.py
        id: version
        run: |
          version=$(grep '__version__' nunchaku/__version__.py | sed -E 's/.*"([^"]+)".*/\1/')
          echo "version=$version" >> "$GITHUB_OUTPUT"
      - name: Check if tag exists
        id: check-tag
        run: |
          tag_name="v${{ steps.version.outputs.version }}"
          if git rev-parse "$tag_name" >/dev/null 2>&1; then
            echo "Tag $tag_name already exists."
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "Tag $tag_name does not exist."
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi
      - name: Create and push tag if not exists
        if: steps.check-tag.outputs.exists == 'false'
        run: |
          tag_name="v${{ steps.version.outputs.version }}"
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git tag "$tag_name"
          git push origin "$tag_name"
      - name: Set tag_name output
        id: set-tag
        run: |
          echo "tag_name=v${{ steps.version.outputs.version }}" >> "$GITHUB_OUTPUT"
  # Stable ABI: only 4 wheels total (2 CUDA Ã— 2 platforms)
  # Single Python (3.12) + single Torch (2.9) for building, but wheel works with Python 3.9+ and Torch 2.9+
  linux-wheels:
    name: Build Linux stable ABI wheel (CUDA ${{ matrix.cuda }})
    runs-on: [self-hosted, linux-build]
    needs: release
    if: github.repository == 'nunchaku-ai/nunchaku'
    strategy:
      matrix:
        cuda: ["12.8", "13.0"]
    steps:
      - name: Checkout to the tag
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ needs.release.outputs.tag_name }}
          submodules: true
      - name: Show current commit
        run: git log -1 --oneline
      - name: Build wheel
        run: bash scripts/build_linux_wheel.sh 3.12 2.9 ${{ matrix.cuda }}
      - name: Verify wheel tag
        run: |
          echo "Built wheels:"
          ls -la dist/*.whl
          # Verify cp39-abi3 tag
          for whl in dist/*.whl; do
            echo "Checking $whl"
            if [[ "$whl" != *cp39-abi3* ]]; then
              echo "ERROR: Wheel does not have cp39-abi3 tag!"
              exit 1
            fi
          done
          echo "All wheels have correct stable ABI tags."
      - name: Upload wheels to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*.whl
          name: Nunchaku ${{ needs.release.outputs.tag_name }}
          tag_name: ${{ needs.release.outputs.tag_name }}
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Clean up
        if: always()
        run: bash scripts/linux_cleanup.sh
  windows-wheels:
    name: Build Windows stable ABI wheel (CUDA ${{ matrix.cuda }})
    runs-on: [self-hosted, win-build]
    needs: release
    if: github.repository == 'nunchaku-ai/nunchaku'
    strategy:
      matrix:
        cuda: ["12.8", "13.0"]
    steps:
      - name: Checkout to the tag
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ needs.release.outputs.tag_name }}
          submodules: true
      - name: Show current commit
        shell: cmd
        run: git log -1 --oneline
      - name: Build wheel
        shell: cmd
        run: |
          call C:\Users\nunchaku\miniconda3\condabin\activate.bat activate
          call scripts\build_windows_wheel.cmd 3.12 2.9 ${{ matrix.cuda }} 8
      - name: Upload wheels to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*.whl
          name: Nunchaku ${{ needs.release.outputs.tag_name }}
          tag_name: ${{ needs.release.outputs.tag_name }}
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  # Test the built wheel under different Python and Torch versions
  test-cross-compatibility:
    name: Test cross-compatibility
    runs-on: [self-hosted, linux-build]
    needs: [release, linux-wheels]
    if: github.repository == 'nunchaku-ai/nunchaku'
    strategy:
      matrix:
        python: ["3.10", "3.12", "3.13"]
        torch: ["2.9", "2.10"]
        cuda: ["12.8"]
    steps:
      - name: Install uv
        run: pip install uv
      - name: Set up test environment
        run: |
          uv venv .venv-test --python ${{ matrix.python }}
          uv pip install --python .venv-test torch==${{ matrix.torch }} --index-url https://download.pytorch.org/whl/cu${{ matrix.cuda }}
      - name: Download wheel from release
        uses: actions/download-artifact@v4
        with:
          pattern: "*.whl"
          path: dist/
      - name: Install and test
        run: |
          source .venv-test/bin/activate
          pip install dist/nunchaku-*-cp39-abi3-linux_x86_64.whl
          python -c "
          from nunchaku._C import QuantizedFluxModel, QuantizedSanaModel, QuantizedGEMM, QuantizedGEMM88
          m = QuantizedFluxModel()
          print('All classes instantiated OK')
          import torch
          print(f'torch version: {torch.__version__}')
          print(f'torch.ops.nunchaku available: {hasattr(torch.ops, \"nunchaku\")}')
          print('Cross-compatibility test PASSED')
          "
      - name: Clean up
        if: always()
        run: rm -rf .venv-test
